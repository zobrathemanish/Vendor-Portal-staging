<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FGI Vendor Portal ‚Äì Phase 1</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
  <meta name="theme-color" content="#C8102E">
  <meta name="apple-mobile-web-app-capable" content="yes">

<style>
  /* ================================
     WINDX-STYLE SYSTEM UI
     ================================ */

  /* Base system font & colors */
  body {
    font-family: "Segoe UI", Tahoma, Arial, sans-serif;
    font-size: 14px;
    color: #000000;
    background-color: #F0F0F0; /* classic Windows gray */
    margin: 0;
  }

  /* Top application bar */
  .navbar {
    height: 48px;
    background-color: #C8102E; /* FGI red */
    border-bottom: 1px solid #8a0f22;
    box-shadow: none;
  }

  .navbar-brand {
    color: #ffffff !important;
    font-weight: normal;
    font-size: 14px;
    letter-spacing: 0;
  }

  /* Main layout container */
  .container {
    max-width: 1100px;
  }

  /* Panel (replace "card" mental model) */
  .card {
    background-color: #FFFFFF;
    border: 1px solid #A0A0A0;
    border-radius: 0;
    box-shadow: none;
    margin-top: 24px;
    padding: 16px;
  }

  /* Section titles */
  h4 {
    font-size: 14px;
    font-weight: bold;
    color: #003399; /* classic Windows blue */
    margin-bottom: 12px;
  }

  /* Labels */
  label {
    font-weight: normal;
    color: #000000;
  }

  /* Inputs (Win32 style) */
  .form-control,
  .form-select {
    font-size: 13px;
    border-radius: 0;
    border: 1px solid #7F9DB9;
    padding: 4px 6px;
  }

  .form-control:focus,
  .form-select:focus {
    outline: none;
    border-color: #003399;
    box-shadow: none;
  }

  /* Primary buttons (system gray) */
  .btn-primary {
    background-color: #E6E6E6;
    color: #000000;
    border: 1px solid #7F9DB9;
    border-radius: 0;
    font-size: 13px;
    font-weight: normal;
    height: 28px;
    padding: 2px 12px;
  }

  .btn-primary:hover:not(:disabled) {
    background-color: #DADADA;
    color: #000000;
  }

  .btn-primary:disabled {
    background-color: #F2F2F2;
    color: #808080;
    border-color: #B0B0B0;
  }

  /* Links (Windows default) */
  a {
    color: #0000EE;
    text-decoration: underline;
    font-size: 13px;
  }

  a:hover {
    color: #551A8B;
  }

  /* Alerts (keep simple & flat) */
  .alert {
    border-radius: 0;
    font-size: 13px;
    padding: 6px 10px;
  }
</style>

</head>

<body>

<nav class="navbar navbar-expand-lg">
  <div class="container">
    <a class="navbar-brand" href="#">
      <img src="{{ url_for('static', filename='fgi_logo.png') }}" height="28" class="me-2">
      FGI Vendor Portal ‚Äì Phase 1
    </a>
  </div>
</nav>

<div class="container">
  <div class="card p-4 bg-white">

    <h4 class="mb-4"> Vendor File Submission</h4>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
            {{ message }}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
          </div>
        {% endfor %}
      {% endif %}
    {% endwith %}

   <form action="{{ url_for('upload_files') }}" method="POST" enctype="multipart/form-data">
    <!-- Submission Type -->
    <div class="mb-3">
      <label class="form-label fw-semibold">Submission Type</label>
      <select class="form-select" name="submission_type" id="submissionType" required>
        <option value="vendor" selected>Vendor Submission</option>
        <option value="pricing_review">Pricing Review</option>
      </select>
    </div>
    

  <input type="hidden" name="asset_blob_path[]" id="assetBlobPaths">

   <input type="hidden" name="vendor_type" id="vendorType">


  <!-- Vendor Select -->
  <div class="mb-3">
    <label class="form-label fw-semibold">Select Vendor</label>
    <select class="form-select" name="vendor_name" id="vendorSelect" required>
      <option value="" disabled selected>Select a vendor...</option>

      <optgroup label="OptiCat Vendors">
        <option value="Dayton Parts" data-type="opticat">Dayton Parts</option>
        <option value="Grote Lighting" data-type="opticat">Grote Lighting</option>
      </optgroup>

      <optgroup label="Non-OptiCat Vendors">
        <option value="Rigid Industries" data-type="non-opticat">Rigid Industries</option>

      </optgroup>
    </select>
  </div>

     <!-- Asset Section -->
<div id="assetSection">
  <div class="mb-3">
    <label class="form-label fw-semibold">Upload Digital Assets (ZIP)</label>
    <input class="form-control" type="file" id="assetZip" accept=".zip" multiple>
    <small class="text-muted">Upload a ZIP containing all images / PDFs.</small>
  </div>

  <div class="progress mt-2 d-none" id="assetUploadProgress">
    <div
      class="progress-bar progress-bar-striped progress-bar-animated"
      role="progressbar"
      style="width: 0%"
      id="assetProgressBar"
    >
      0%
    </div>
  </div>
</div>

  <!-- OptiCat Section -->
  <div id="opticatSection" style="display:none;">
    <div class="mb-3">
      <label class="form-label">Attach Product File (.xml)</label>
      <input class="form-control" type="file" name="product_file" accept=".xml">
    </div>

    <div class="mb-3">
      <label class="form-label">Attach Pricing File (.xlsx)</label>
      <input class="form-control" type="file" name="pricing_file" accept=".xlsx">
    </div>
  </div>

  <!-- Non-OptiCat Section -->
  <div id="nonOpticatSection" style="display:none;">
    <div class="mb-3">
      <label class="form-label">Upload Vendor File (.xlsx)</label>
      <input class="form-control" type="file" name="non_opticat_file" accept=".xlsx">
    </div>
  </div>

  <!-- Pricing Review Section -->
  <div id="pricingReviewSection" style="display:none;">
    <div class="alert alert-warning">
      <strong>Pricing Review</strong><br>
      Upload the final reviewed pricing file.
    </div>

    <div class="mb-3">
      <label class="form-label fw-semibold">
        Reviewed Full Pricing File (.xlsx)
      </label>
      <input
        class="form-control"
        type="file"
        name="approved_pricing_file"
        accept=".xlsx"
      >
    </div>
  </div>


  <!-- Submit -->
  <div class="d-grid mb-3">
    <button type="submit" class="btn btn-primary" id="submitBtn">Submit</button>
  </div>

  <div class="text-center">
    <a href="{{ url_for('download_template') }}" class="me-3">üìÑ Download Standard Template</a>
    <a href="{{ url_for('single_product_page') }}">üîß Submit Single Product Manually</a>
    <a href="{{ url_for('form_submission_help') }}">üìù Help</a>
  </div>

</form>

<script>
  const submissionType = document.getElementById("submissionType");
  const vendorSelect = document.getElementById("vendorSelect");

  const opticatSection = document.getElementById("opticatSection");
  const nonOpticatSection = document.getElementById("nonOpticatSection");
  const pricingReviewSection = document.getElementById("pricingReviewSection");
  const assetSection = document.getElementById("assetSection");
  const vendorTypeInput = document.getElementById("vendorType");

  const pricingFileInput = document.querySelector(
    'input[name="approved_pricing_file"]'
  );

  function resetVendorSections() {
    opticatSection.style.display = "none";
    nonOpticatSection.style.display = "none";
    vendorTypeInput.value = "";
  }

  submissionType.addEventListener("change", function () {
    if (this.value === "pricing_review") {
      resetVendorSections();
      assetSection.style.display = "none";
      pricingReviewSection.style.display = "block";

      // ‚úÖ REQUIRED only for pricing review
      pricingFileInput.required = true;

    } else {
      pricingReviewSection.style.display = "none";
      assetSection.style.display = "block";

      // ‚úÖ NOT required for vendor submission
      pricingFileInput.required = false;

      vendorSelect.dispatchEvent(new Event("change"));
    }
  });


  vendorSelect.addEventListener("change", function () {
    if (submissionType.value === "pricing_review") {
      resetVendorSections();
      return;
    }

    const selected = this.options[this.selectedIndex];
    const type = selected.getAttribute("data-type");

    vendorTypeInput.value = type;

    if (type === "opticat") {
      opticatSection.style.display = "block";
      nonOpticatSection.style.display = "none";
    } else {
      opticatSection.style.display = "none";
      nonOpticatSection.style.display = "block";
    }
  });
</script>

<script type="module">
  import { BlockBlobClient } from "https://cdn.jsdelivr.net/npm/@azure/storage-blob/+esm";

  let assetUploadInProgress = false;

  const zipInput = document.getElementById("assetZip");
  const blobPathInput = document.getElementById("assetBlobPaths");
  const submitBtn = document.getElementById("submitBtn");

  const progressContainer = document.getElementById("assetUploadProgress");
  const progressBar = document.getElementById("assetProgressBar");

  const form = document.querySelector("form");

  const MAX_BROWSER_UPLOAD_GB = 1.98;

  zipInput?.addEventListener("change", async () => {
    const files = Array.from(zipInput.files);
    if (!files.length) return;

    const vendor = document.getElementById("vendorSelect").value;
    const finalBlobPaths = [];
    let anyUploadOccurred = false;

    // üîí Size guard (per ZIP)
    for (const file of files) {
      const fileSizeGB = file.size / (1024 ** 3);
      if (fileSizeGB > MAX_BROWSER_UPLOAD_GB) {
        alert(
          `ZIP "${file.name}" is ${fileSizeGB.toFixed(1)} GB.\n\n` +
          `Browser uploads above ${MAX_BROWSER_UPLOAD_GB} GB are unreliable.\n` +
          `Please split this ZIP or contact the data team.`
        );
        zipInput.value = "";
        return;
      }
    }

    assetUploadInProgress = true;
    submitBtn.disabled = true;

    // Reset progress UI
    progressContainer.classList.remove("d-none");
    progressBar.style.width = "0%";
    progressBar.textContent = "0%";
    progressBar.className =
      "progress-bar progress-bar-striped progress-bar-animated";

    try {
      for (const file of files) {
        // üîê STEP 1: Compute hash (per ZIP)
        const fileHash = await computeFileHash(file);

        // üîç STEP 2: Ask backend if THIS ZIP exists
        const hashCheckRes = await fetch("/api/check-asset-hash", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            vendor,
            file_hash: fileHash,
            filename: file.name
          })
        });

        const hashResult = await hashCheckRes.json();

        // ‚è≠ REUSE UNCHANGED ZIP
        if (hashResult.skip) {
          finalBlobPaths.push(hashResult.existing_blob_path);

          progressBar.style.width = "100%";
          progressBar.classList.remove("progress-bar-animated");
          progressBar.classList.add("bg-info");
          progressBar.textContent = `Reused: ${file.name}`;

          continue;
        }

        anyUploadOccurred = true;

        // üîë STEP 3: Get SAS
        const res = await fetch("/api/get-asset-upload-sas", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            vendor,
            filename: file.name
          })
        });

        if (!res.ok) {
          throw new Error("SAS_GENERATION_FAILED");
        }

        const data = await res.json();
        const blobClient = new BlockBlobClient(data.sas_url);

        // ‚¨ÜÔ∏è STEP 4: Upload ZIP
        await blobClient.uploadBrowserData(file, {
          blobHTTPHeaders: { blobContentType: "application/zip" },
          onProgress: (progress) => {
            const percent = Math.round(
              (progress.loadedBytes / file.size) * 100
            );
            progressBar.style.width = `${percent}%`;
            progressBar.textContent = `${file.name}: ${percent}%`;
          }
        });

        finalBlobPaths.push(data.blob_path);
      }

      // üßπ STEP 5: Cleanup ONLY if something changed
      if (anyUploadOccurred) {
        await fetch("/api/cleanup-old-assets", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            vendor,
            keep_blob_paths: finalBlobPaths
          })
        });
      }

      blobPathInput.value = JSON.stringify(finalBlobPaths);

      progressBar.classList.remove("progress-bar-animated");
      progressBar.classList.add("bg-success");
      progressBar.textContent = "Assets ready";

    } catch (err) {
      console.error("Asset upload error:", err);

      progressBar.classList.remove("progress-bar-animated");
      progressBar.classList.add("bg-danger");
      progressBar.textContent = "Upload failed";

      alert(
        err.message === "SAS_GENERATION_FAILED"
          ? "Failed to initialize asset upload. Please refresh and retry."
          : "Asset upload failed due to browser or network issues."
      );

      blobPathInput.value = "";
    } finally {
      assetUploadInProgress = false;
      submitBtn.disabled = false;
    }
  });

  // üö´ Prevent submit if assets not uploaded
  form.addEventListener("submit", function (e) {
    const submissionType = document.getElementById("submissionType").value;

    // üö´ Asset validation ONLY for vendor submissions
    if (submissionType === "vendor") {
      if (assetUploadInProgress || !blobPathInput.value) {
        e.preventDefault();
        alert("Please upload assets successfully before submitting.");
      }
    }
  });


  async function computeFileHash(file) {
    const buffer = await file.arrayBuffer();
    const hashBuffer = await crypto.subtle.digest("SHA-256", buffer);
    return Array.from(new Uint8Array(hashBuffer))
      .map(b => b.toString(16).padStart(2, "0"))
      .join("");
  }
</script>


  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("/static/sw.js")
        .then(() => console.log("Service Worker registered"))
        .catch(err => console.error("Service Worker registration failed", err));
    });
  }
</script>
</body>
</html>
