<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>FGI Vendor Portal ‚Äì Phase 1</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
  <meta name="theme-color" content="#C8102E">
  <meta name="apple-mobile-web-app-capable" content="yes">

<style>
/* ================================
   WINDX-STYLE SYSTEM UI (CLEAN)
   ================================ */

/* ---------- Base ---------- */
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
}

body {
  font-family: "Segoe UI", Tahoma, Arial, sans-serif;
  font-size: 14px;
  color: #000;
  background-color: #E5E5E5;
  overflow: hidden;
}

#app-shell {
  height: 100%;
}

/* ---------- Title Bar ---------- */
.windx-titlebar {
  display: grid;
  grid-template-columns: 1fr auto 1fr;
  align-items: center;
  height: 50px;
  padding: 0 20px;
  background: #FFFFFF;
  border-bottom: 2px solid #000;
  font-size: 16px;
}

.system-top-bar {
  height: 20px;               /* thicker black band */
  background: #000;
  display: flex;
  align-items: center;
}

.system-top-line {
  width: 100%;
  height: 2px;
  background: #FFF;
}

.title-left { justify-self: start; }
.title-center { justify-self: center; font-weight: bold; }
.title-right { justify-self: end; }

/* ---------- System Shell ---------- */
.system-shell {
  display: flex;
  height: calc(100vh - 50px);
  width: 100%;
}

/* ---------- Side Rails ---------- */
.system-rail {
  width: 16px;
  background: #000;
  display: flex;
  justify-content: center;
}

.system-rail-line {
  width: 2px;
  background: #FFF;
  height: 100%;
}

/* ---------- Center Column ---------- */
.system-center {
  flex: 1;
  display: flex;
  flex-direction: column;
  background: #E5E5E5;
}

/* ---------- Workspace ---------- */
.app-workspace {
  flex: 1;
  background: #E5E5E5;
  padding-top: 20px;
}

/* IMPORTANT: container must NOT fight the rails */
.container {
  max-width: 1080px;
  width: 100%;
  margin: 12px auto 0 auto;
}

/* ---------- Workspace Frame ---------- */
.workspace-frame {
  background: #E6E6E6;
  padding: 80px 10px;
  border: none;
}

/* ---------- Cards ---------- */
.card {
  background: #FFF;
  border: 1px solid #A0A0A0;
  padding: 16px;
}

/* ---------- Forms ---------- */
.form-control,
.form-select {
  font-size: 13px;
  border-radius: 0;
  border: 1px solid #7F9DB9;
  padding: 4px 6px;
}

.form-control:focus,
.form-select:focus {
  outline: none;
  border-color: #003399;
  box-shadow: none;
}

/* ---------- Buttons ---------- */
.btn-primary {
  background: #E6E6E6;
  color: #000;
  border: 1px solid #7F9DB9;
  border-radius: 0;
  height: 28px;
}

.btn-primary:hover:not(:disabled) {
  background: #DADADA;
}

/* ---------- Links ---------- */
a {
  color: #0000EE;
  text-decoration: underline;
  font-size: 13px;
}

/* ---------- System Bottom Bar ---------- */
.system-bottom-bar {
  height: 16px;
  background: #000;
  display: flex;
  align-items: center;
}

.system-bottom-line {
  width: 100%;
  height: 2px;
  background: #FFF;
}
</style>

</head>

<body>
<div id="app-shell">

  <!-- TITLE BAR -->
  <div class="windx-titlebar">
    <div class="title-left" id="sys-date"></div>
    <div class="title-center">Fort Garry Industries</div>
    <div class="title-right" id="sys-time"></div>
  </div>

  <!-- SYSTEM SHELL -->
  <div class="system-shell">

    <!-- LEFT SYSTEM RAIL -->
    <div class="system-rail left">
      <div class="system-rail-line"></div>
    </div>

    <!-- CENTER COLUMN -->
    <div class="system-center">
      <!-- TOP SYSTEM BAR -->
      <div class="system-top-bar">
        <div class="system-top-line"></div>
      </div>
      
      <!-- MAIN WORKSPACE -->
      <div class="app-workspace">
        <div class="container">

          <div class="workspace-frame">
            <div class="row">

              <!-- LEFT: MAIN FORM -->
              <div class="col" style="flex: 0 0 750px; max-width: 750px;">
                <div class="card">

                  <h4 class="mb-4">Vendor file submission</h4>

                  {% with messages = get_flashed_messages(with_categories=true) %}
                    {% if messages %}
                      {% for category, message in messages %}
                        <div class="alert alert-{{ category }}">{{ message }}</div>
                      {% endfor %}
                    {% endif %}
                  {% endwith %}

                  <form action="{{ url_for('upload_files') }}" method="POST" enctype="multipart/form-data">

                    <!-- Submission Type -->
                    <div class="mb-3">
                      <label class="form-label fw-semibold">Submission Type</label>
                      <select class="form-select" name="submission_type" id="submissionType" required>
                        <option value="vendor" selected>Vendor Submission</option>
                        <option value="pricing_review">Pricing Review</option>
                      </select>
                    </div>

                    <input type="hidden" name="asset_blob_path[]" id="assetBlobPaths">
                    <input type="hidden" name="vendor_type" id="vendorType">

                    <!-- Vendor Select -->
                    <div class="mb-3">
                      <label class="form-label fw-semibold">Select Vendor</label>
                      <select class="form-select" name="vendor_name" id="vendorSelect" required>
                        <option value="" disabled selected>Select a vendor...</option>

                        <optgroup label="OptiCat Vendors">
                          <option value="Dayton Parts" data-type="opticat">Dayton Parts</option>
                          <option value="Grote Lighting" data-type="opticat">Grote Lighting</option>
                        </optgroup>

                        <optgroup label="Non-OptiCat Vendors">
                          <option value="Rigid Industries" data-type="non-opticat">Rigid Industries</option>
                        </optgroup>
                      </select>
                    </div>

                    <!-- Asset Section -->
                    <div id="assetSection">
                      <div class="mb-3">
                        <label class="form-label fw-semibold">Upload Digital Assets (ZIP)</label>
                        <input class="form-control" type="file" id="assetZip" accept=".zip" multiple>
                        <small class="text-muted">Upload a ZIP containing all images / PDFs.</small>
                      </div>

                      <div class="progress mt-2 d-none" id="assetUploadProgress">
                        <div class="progress-bar progress-bar-striped progress-bar-animated"
                             role="progressbar" style="width:0%" id="assetProgressBar">0%</div>
                      </div>
                    </div>

                    <!-- OptiCat -->
                    <div id="opticatSection" style="display:none;">
                      <div class="mb-3">
                        <label class="form-label">Attach Product File (.xml)</label>
                        <input class="form-control" type="file" name="product_file" accept=".xml">
                      </div>
                      <div class="mb-3">
                        <label class="form-label">Attach Pricing File (.xlsx)</label>
                        <input class="form-control" type="file" name="pricing_file" accept=".xlsx">
                      </div>
                    </div>

                    <!-- Non-OptiCat -->
                    <div id="nonOpticatSection" style="display:none;">
                      <div class="mb-3">
                        <label class="form-label">Upload Vendor File (.xlsx)</label>
                        <input class="form-control" type="file" name="non_opticat_file" accept=".xlsx">
                      </div>
                    </div>

                    <!-- Pricing Review -->
                    <div id="pricingReviewSection" style="display:none;">
                      <div class="alert alert-warning">
                        <strong>Pricing Review</strong><br>
                        Upload the final reviewed pricing file.
                      </div>
                      <div class="mb-3">
                        <label class="form-label fw-semibold">Reviewed Full Pricing File (.xlsx)</label>
                        <input class="form-control" type="file"
                               name="approved_pricing_file" accept=".xlsx">
                      </div>
                    </div>

                    <!-- Submit -->
                    <div class="d-grid mb-3">
                      <button type="submit" class="btn btn-primary" id="submitBtn">Submit</button>
                    </div>

                    <div class="text-center">
                      <a href="{{ url_for('download_template') }}" class="me-3">üìÑ Download Standard Template</a>
                      <a href="{{ url_for('single_product_page') }}">üîß Submit Single Product Manually</a>
                      <a href="{{ url_for('form_submission_help') }}">üìù Help</a>
                    </div>

                  </form>
                </div>
              </div>

              <!-- RIGHT: STATUS PANEL -->
              <div class="col" style="flex: 0 0 280px; max-width: 280px;">
                <div class="card system-panel">
                  <h5>Submission status</h5>
                  <p class="status-idle">
                    System idle.<br>
                    Waiting for vendor submission.
                  </p>
                </div>
              </div>

            </div>
          </div>
        </div>
      </div>

      <!-- BOTTOM SYSTEM BAR (RAIL-TO-RAIL) -->
      <div class="system-bottom-bar">
        <div class="system-bottom-line"></div>
      </div>

    </div>

    <!-- RIGHT SYSTEM RAIL -->
    <div class="system-rail right">
      <div class="system-rail-line"></div>
    </div>

  </div>
</div>

<script>
  const submissionType = document.getElementById("submissionType");
  const vendorSelect = document.getElementById("vendorSelect");

  const opticatSection = document.getElementById("opticatSection");
  const nonOpticatSection = document.getElementById("nonOpticatSection");
  const pricingReviewSection = document.getElementById("pricingReviewSection");
  const assetSection = document.getElementById("assetSection");
  const vendorTypeInput = document.getElementById("vendorType");

  const pricingFileInput = document.querySelector(
    'input[name="approved_pricing_file"]'
  );

  function resetVendorSections() {
    opticatSection.style.display = "none";
    nonOpticatSection.style.display = "none";
    vendorTypeInput.value = "";
  }

  submissionType.addEventListener("change", function () {
    if (this.value === "pricing_review") {
      resetVendorSections();
      assetSection.style.display = "none";
      pricingReviewSection.style.display = "block";

      // ‚úÖ REQUIRED only for pricing review
      pricingFileInput.required = true;

    } else {
      pricingReviewSection.style.display = "none";
      assetSection.style.display = "block";

      // ‚úÖ NOT required for vendor submission
      pricingFileInput.required = false;

      vendorSelect.dispatchEvent(new Event("change"));
    }
  });


  vendorSelect.addEventListener("change", function () {
    if (submissionType.value === "pricing_review") {
      resetVendorSections();
      return;
    }

    const selected = this.options[this.selectedIndex];
    const type = selected.getAttribute("data-type");

    vendorTypeInput.value = type;

    if (type === "opticat") {
      opticatSection.style.display = "block";
      nonOpticatSection.style.display = "none";
    } else {
      opticatSection.style.display = "none";
      nonOpticatSection.style.display = "block";
    }
  });
</script>

<script type="module">
  import { BlockBlobClient } from "https://cdn.jsdelivr.net/npm/@azure/storage-blob/+esm";

  let assetUploadInProgress = false;

  const zipInput = document.getElementById("assetZip");
  const blobPathInput = document.getElementById("assetBlobPaths");
  const submitBtn = document.getElementById("submitBtn");

  const progressContainer = document.getElementById("assetUploadProgress");
  const progressBar = document.getElementById("assetProgressBar");

  const form = document.querySelector("form");

  const MAX_BROWSER_UPLOAD_GB = 1.98;

  zipInput?.addEventListener("change", async () => {
    const files = Array.from(zipInput.files);
    if (!files.length) return;

    const vendor = document.getElementById("vendorSelect").value;
    const finalBlobPaths = [];
    let anyUploadOccurred = false;

    // üîí Size guard (per ZIP)
    for (const file of files) {
      const fileSizeGB = file.size / (1024 ** 3);
      if (fileSizeGB > MAX_BROWSER_UPLOAD_GB) {
        alert(
          `ZIP "${file.name}" is ${fileSizeGB.toFixed(1)} GB.\n\n` +
          `Browser uploads above ${MAX_BROWSER_UPLOAD_GB} GB are unreliable.\n` +
          `Please split this ZIP or contact the data team.`
        );
        zipInput.value = "";
        return;
      }
    }

    assetUploadInProgress = true;
    submitBtn.disabled = true;

    // Reset progress UI
    progressContainer.classList.remove("d-none");
    progressBar.style.width = "0%";
    progressBar.textContent = "0%";
    progressBar.className =
      "progress-bar progress-bar-striped progress-bar-animated";

    try {
      for (const file of files) {
        // üîê STEP 1: Compute hash (per ZIP)
        const fileHash = await computeFileHash(file);

        // üîç STEP 2: Ask backend if THIS ZIP exists
        const hashCheckRes = await fetch("/api/check-asset-hash", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            vendor,
            file_hash: fileHash,
            filename: file.name
          })
        });

        const hashResult = await hashCheckRes.json();

        // ‚è≠ REUSE UNCHANGED ZIP
        if (hashResult.skip) {
          finalBlobPaths.push(hashResult.existing_blob_path);

          progressBar.style.width = "100%";
          progressBar.classList.remove("progress-bar-animated");
          progressBar.classList.add("bg-info");
          progressBar.textContent = `Reused: ${file.name}`;

          continue;
        }

        anyUploadOccurred = true;

        // üîë STEP 3: Get SAS
        const res = await fetch("/api/get-asset-upload-sas", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            vendor,
            filename: file.name
          })
        });

        if (!res.ok) {
          throw new Error("SAS_GENERATION_FAILED");
        }

        const data = await res.json();
        const blobClient = new BlockBlobClient(data.sas_url);

        // ‚¨ÜÔ∏è STEP 4: Upload ZIP
        await blobClient.uploadBrowserData(file, {
          blobHTTPHeaders: { blobContentType: "application/zip" },
          onProgress: (progress) => {
            const percent = Math.round(
              (progress.loadedBytes / file.size) * 100
            );
            progressBar.style.width = `${percent}%`;
            progressBar.textContent = `${file.name}: ${percent}%`;
          }
        });

        finalBlobPaths.push(data.blob_path);
      }

      // üßπ STEP 5: Cleanup ONLY if something changed
      if (anyUploadOccurred) {
        await fetch("/api/cleanup-old-assets", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            vendor,
            keep_blob_paths: finalBlobPaths
          })
        });
      }

      blobPathInput.value = JSON.stringify(finalBlobPaths);

      progressBar.classList.remove("progress-bar-animated");
      progressBar.classList.add("bg-success");
      progressBar.textContent = "Assets ready";

    } catch (err) {
      console.error("Asset upload error:", err);

      progressBar.classList.remove("progress-bar-animated");
      progressBar.classList.add("bg-danger");
      progressBar.textContent = "Upload failed";

      alert(
        err.message === "SAS_GENERATION_FAILED"
          ? "Failed to initialize asset upload. Please refresh and retry."
          : "Asset upload failed due to browser or network issues."
      );

      blobPathInput.value = "";
    } finally {
      assetUploadInProgress = false;
      submitBtn.disabled = false;
    }
  });

  // üö´ Prevent submit if assets not uploaded
  form.addEventListener("submit", function (e) {
    const submissionType = document.getElementById("submissionType").value;

    // üö´ Asset validation ONLY for vendor submissions
    if (submissionType === "vendor") {
      if (assetUploadInProgress || !blobPathInput.value) {
        e.preventDefault();
        alert("Please upload assets successfully before submitting.");
      }
    }
  });


  async function computeFileHash(file) {
    const buffer = await file.arrayBuffer();
    const hashBuffer = await crypto.subtle.digest("SHA-256", buffer);
    return Array.from(new Uint8Array(hashBuffer))
      .map(b => b.toString(16).padStart(2, "0"))
      .join("");
  }
</script>


  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("/static/sw.js")
        .then(() => console.log("Service Worker registered"))
        .catch(err => console.error("Service Worker registration failed", err));
    });
  }
</script>
<script>
  window.addEventListener("load", () => {
    if (window.matchMedia("(display-mode: standalone)").matches) {
      window.resizeTo(1100, 720);
    }
  });
</script>
<script>
  function updateSystemTime() {
    const now = new Date();

    const dateStr = now.toLocaleDateString(undefined, {
      year: "numeric",
      month: "long",
      day: "2-digit"
    });

    const timeStr = now.toLocaleTimeString(undefined, {
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit"
    });

    document.getElementById("sys-date").textContent = dateStr;
    document.getElementById("sys-time").textContent = timeStr;
  }

  updateSystemTime();
  setInterval(updateSystemTime, 1000);
</script>


</div>
</body>
</html>
